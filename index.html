<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>NaviTech Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    #warning {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff3b3b;
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      display: none;
      z-index: 999;
    }

    #vehicle-selector {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
    }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="warning">ðŸš« Seu veÃ­culo NÃƒO pode passar aqui</div>

  <div id="vehicle-selector">
    <select id="vehicleSelect">
      <option value="caminhao_3_4">CaminhÃ£o 3/4</option>
      <option value="toco">Toco</option>
      <option value="carreta">Carreta</option>
    </select>
  </div>

<script>
/* ================= VARIÃVEIS GLOBAIS ================= */

const vehicles = {
  caminhao_3_4: { maxHeight: 3.2, maxWidth: 2.3, maxWeight: 8000 },
  toco: { maxHeight: 3.8, maxWidth: 2.5, maxWeight: 16000 },
  carreta: { maxHeight: 4.4, maxWidth: 2.6, maxWeight: 24000 }
};

let currentVehicle = vehicles.caminhao_3_4;
let selectedRoad = null;

const zoneLimits = {
  maxHeight: 3.5,
  maxWidth: 2.4,
  maxWeight: 12000
};

mapboxgl.accessToken = 'pk.eyJ1IjoibG9yZHRvcGgiLCJhIjoiY21rdmk0Zzh0MDZ4bTNjb2FlYjNucjV4NSJ9.IrJ9nEUX97lUvdPP0OHzAQ';

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/streets-v12',
  center: [-44.022889, -19.979206],
  zoom: 14
});

/* ================= FUNÃ‡Ã•ES ================= */

function distanceBetweenPoints(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(lat1 * Math.PI / 180) *
    Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon / 2) ** 2;

  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

function detectarRua(e) {
  const features = map.queryRenderedFeatures(e.point)
    .filter(f => f.layer.id.startsWith('road-') && !f.layer.id.includes('label'));

  if (!features.length) return;

  // fecha popup anterior
  if (activePopup) {
    activePopup.remove();
  }

  activePopup = new mapboxgl.Popup()
    .setLngLat(e.lngLat)
    .setHTML(`<b>Rua selecionada</b>`)
    .addTo(map);
}

function distanciaEmMetros(coord1, coord2) {
  const R = 6371000;
  const toRad = deg => deg * Math.PI / 180;

  const dLat = toRad(coord2[1] - coord1[1]);
  const dLng = toRad(coord2[0] - coord1[0]);

  const a =
    Math.sin(dLat / 2) ** 2 +
    Math.cos(toRad(coord1[1])) *
    Math.cos(toRad(coord2[1])) *
    Math.sin(dLng / 2) ** 2;

  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}

/* ================= MAP LOAD ================= */

map.on('load', () => {

  // ===============================
  // ZONA RESTRITA (POLÃGONO)
  // ===============================
  map.addSource('restricted-zone', {
    type: 'geojson',
    data: {
      type: 'Feature',
      geometry: {
        type: 'Polygon',
        coordinates: [[
          [-44.0233, -19.9795],
          [-44.0225, -19.9795],
          [-44.0225, -19.9789],
          [-44.0233, -19.9789],
          [-44.0233, -19.9795]
        ]]
      }
    }
  });

  map.addLayer({
    id: 'restricted-zone-layer',
    type: 'fill',
    source: 'restricted-zone',
    paint: {
      'fill-color': '#ff0000',
      'fill-opacity': 0.4
    }
  });

  // ===============================
  // CLIQUE NA RUA (SELEÃ‡ÃƒO)
  // ===============================
  map.on('click', (e) => {

    const features = map.queryRenderedFeatures(e.point);

    const roadFeature = features.find(f =>
      f.geometry &&
      f.geometry.type === 'LineString' &&
      f.layer.type === 'line'
    );

    if (!roadFeature) {
      console.log('Nenhuma rua clicada');
      return;
    }

    selectedRoad = roadFeature;

    // Remove seleÃ§Ã£o anterior
    if (map.getLayer('selected-road')) {
      map.removeLayer('selected-road');
      map.removeSource('selected-road');
    }

    // Cria fonte da rua selecionada
    map.addSource('selected-road', {
      type: 'geojson',
      data: {
        type: 'Feature',
        geometry: roadFeature.geometry
      }
    });

    // Desenha a rua em vermelho
    map.addLayer({
      id: 'selected-road',
      type: 'line',
      source: 'selected-road',
      paint: {
        'line-color': '#ff0000',
        'line-width': 6
      }
    });

    const roadName = roadFeature.properties?.name || 'Via sem nome';
    console.log('Rua selecionada:', roadName);
  });

});

map.on('moveend', () => {
  if (!userLocation || !lastCenter) return;

  const center = map.getCenter();
  const atual = [center.lng, center.lat];

  const distancia = distanciaEmMetros(lastCenter, atual);

  if (distancia > 200) {
    // usuÃ¡rio se afastou bastante
    // NÃƒO RECENTRALIZA automaticamente
    console.log('UsuÃ¡rio longe da posiÃ§Ã£o inicial');
  }
});
map.addControl(
  new mapboxgl.GeolocateControl({
    positionOptions: {
      enableHighAccuracy: true
    },
    trackUserLocation: false,
    showUserHeading: true
  }),
  'bottom-right'
);

let activePopup = null
let userLocation = null;
let lastCenter = null;
let pressTimer = null;
let pressDuration = 600; // tempo em ms para considerar long press
let startPoint = null;

// MOUSE
map.on('mousedown', (e) => {
  startPoint = e.point;

  pressTimer = setTimeout(() => {
    detectarRua(e);
  }, pressDuration);
});

map.on('mouseup', () => {
  clearTimeout(pressTimer);
});

map.on('mousemove', (e) => {
  if (!startPoint) return;

  // cancela se o usuÃ¡rio arrastar
  if (Math.abs(e.point.x - startPoint.x) > 5 || Math.abs(e.point.y - startPoint.y) > 5) {
    clearTimeout(pressTimer);
  }
});

// TOUCH (celular)
map.on('touchstart', (e) => {
  startPoint = e.point;

  pressTimer = setTimeout(() => {
    detectarRua(e);
  }, pressDuration);
});

map.on('touchend', () => {
  clearTimeout(pressTimer);
});

navigator.geolocation.getCurrentPosition((pos) => {
  userLocation = [pos.coords.longitude, pos.coords.latitude];
  lastCenter = userLocation;
});

  const vehicleMarker = new mapboxgl.Marker({ color: '#1E90FF' });

  navigator.geolocation.watchPosition((pos) => {
  userLocation = [pos.coords.longitude, pos.coords.latitude];

  if (!lastCenter) {
    lastCenter = userLocation;
  }
});

    vehicleMarker.setLngLat([lng, lat]).addTo(map);

    const distance = distanceBetweenPoints(
      lat, lng,
      -19.9792, -44.0229
    );

    const canPass =
      currentVehicle.maxHeight <= zoneLimits.maxHeight &&
      currentVehicle.maxWidth <= zoneLimits.maxWidth &&
      currentVehicle.maxWeight <= zoneLimits.maxWeight;

    document.getElementById('warning').style.display =
      distance < 200 && !canPass ? 'block' : 'none';

    map.easeTo({ center: [lng, lat], zoom: 16 });
  });

/* ================= SELECT ================= */

document.getElementById('vehicleSelect').addEventListener('change', e => {
  currentVehicle = vehicles[e.target.value];
});
</script>

</body>
</html>